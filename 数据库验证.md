
### 详细规划

#### 一、项目阶段划分
1. **数据库初始化与验证阶段**
   - 目标：确保所有拆分的schema文件正确部署到数据库，表结构、关系及约束符合设计要求
   - 关键任务：执行SQL文件、验证对象创建、测试数据插入、约束有效性检查

2. **数据集成阶段**
   - 目标：建立与外部数据源（Tushare/Akshare）的连接，实现自动化数据同步
   - 关键任务：API密钥配置、数据同步脚本开发、增量更新机制实现、数据质量监控

3. **核心功能开发阶段**
   - 目标：实现因子计算、财务分析、市场指标等核心业务逻辑
   - 关键任务：因子引擎开发、技术指标计算、财务比率分析、数据可视化接口

4. **测试与优化阶段**
   - 目标：确保系统功能正确性、性能稳定性和数据准确性
   - 关键任务：单元测试编写、集成测试执行、性能瓶颈优化、数据一致性校验

5. **部署与监控阶段**
   - 目标：构建可靠的生产环境部署流程和运行时监控体系
   - 关键任务：Docker容器化、CI/CD流程配置、系统监控告警、日志分析系统


### 详细步骤

#### 第一阶段：数据库初始化与验证（预计3个工作日）

**步骤1：环境准备**
```powershell
# 1.1 检查PostgreSQL服务状态
Get-Service postgresql*

# 1.2 创建项目专用数据库
psql -U postgres -c "CREATE DATABASE stockschool WITH ENCODING 'UTF8' LC_COLLATE='zh_CN.UTF-8' LC_CTYPE='zh_CN.UTF-8';"

# 1.3 创建扩展（TimescaleDB等）
psql -U postgres -d stockschool -f schema/init/extensions.sql
```

**步骤2：执行Schema文件**
```powershell
# 2.1 按依赖顺序执行SQL文件（共15个）
psql -U postgres -d stockschool -f schema/init/permissions.sql
psql -U postgres -d stockschool -f schema/financial/cash_flow.sql
# ... 执行其他schema文件

# 2.2 验证对象创建结果
psql -U postgres -d stockschool -c "\dt schema_name.*"  # 检查各schema下的表
psql -U postgres -d stockschool -c "\df schema_name.*"  # 检查函数
psql -U postgres -d stockschool -c "\dv schema_name.*"  # 检查视图
```

**步骤3：数据验证**
```powershell
# 3.1 插入测试数据
psql -U postgres -d stockschool -c "INSERT INTO financial.cash_flow (...) VALUES (...);"

# 3.2 运行数据质量检查函数
psql -U postgres -d stockschool -c "SELECT check_data_quality('financial.cash_flow');"

# 3.3 使用context7验证约束有效性
run_mcp {"server_name":"mcp.config.usrlocalmcp.context7","tool_name":"get-library-docs","args":{"context7CompatibleLibraryID":"/context7/postgresql-current","topic":"constraint validation","tokens":5000}}
```

#### 第二阶段：数据集成（预计5个工作日）

**步骤4：数据源配置**
```powershell
# 4.1 创建API配置文件
New-Item -Path config -Name api_config.json -ItemType File -Value '{"tushare":{"token":"YOUR_TOKEN"},"akshare":{"enable":true}}'

# 4.2 安装数据采集依赖
pip install -r requirements.txt
```

**步骤5：开发同步脚本**
```powershell
# 5.1 创建Tushare数据同步脚本
New-Item -Path src/data -Name tushare_sync.py -ItemType File

# 5.2 实现基础数据同步（股票列表）
python src/data/tushare_sync.py --table stock_basic --frequency daily
```

**步骤6：设置定时任务**
```powershell
# 6.1 创建Windows计划任务
schtasks /create /tn "StockDataSync" /tr "python d:\Users\xuxuz\Desktop\StockSchool\src\data\sync_all.py" /sc daily /st 08:00
```

#### 第三阶段：核心功能开发（预计10个工作日）

**步骤7：因子计算引擎开发**
```powershell
# 7.1 创建因子计算模块
code src/compute/factor_engine.py

# 7.2 实现MACD因子计算
# 在factor_engine.py中添加MACD计算函数
# 使用context7验证算法正确性
run_mcp {"server_name":"mcp.config.usrlocalmcp.context7","tool_name":"get-library-docs","args":{"context7CompatibleLibraryID":"/context7/postgresql-current","topic":"MACD calculation","tokens":5000}}
```

**步骤8：API服务开发**
```powershell
# 8.1 创建FastAPI应用
code src/api/main.py

# 8.2 实现股票数据查询接口
# 添加GET /api/stock/{ts_code}端点
```

#### 第四阶段：测试与优化（预计4个工作日）

**步骤9：单元测试**
```powershell
# 9.1 运行现有测试
pytest src/tests/

# 9.2 添加新测试用例
code src/tests/test_factor_calculation.py
```

**步骤10：性能优化**
```powershell
# 10.1 分析慢查询
psql -U postgres -d stockschool -c "EXPLAIN ANALYZE SELECT * FROM market_data.stock_daily WHERE trade_date > '2023-01-01';"

# 10.2 添加缺失索引
psql -U postgres -d stockschool -c "CREATE INDEX idx_trade_date ON market_data.stock_daily(trade_date);"
```

#### 第五阶段：部署与监控（预计3个工作日）

**步骤11：Docker容器化**
```powershell
# 11.1 构建Docker镜像
docker build -t stockschool:latest .

# 11.2 启动容器集群
docker-compose up -d
```

**步骤12：监控配置**
```powershell
# 12.1 启动Prometheus监控
docker run -d -p 9090:9090 -v d:/Users/xuxuz/Desktop/StockSchool/config/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
```

### 关键里程碑与决策点
1. **数据库验证完成**（阶段一结束）
   - 交付物：验证报告、测试数据集
   - 决策点：是否进入数据集成阶段

2. **首个数据源对接完成**（步骤5后）
   - 交付物：同步脚本、数据样例
   - 决策点：是否扩展其他数据源

3. **MVP功能完成**（阶段三结束）
   - 交付物：核心功能演示系统
   - 决策点：是否进行内部测试

### 风险控制措施
1. **代码安全**：所有SQL变更需通过context7验证
2. **数据安全**：API密钥使用环境变量，不硬编码
3. **进度控制**：每个步骤设置20%缓冲时间
4. **问题处理**：建立issue跟踪清单，每日同步进度

请审阅此规划和步骤，如有调整需求或优先事项变更，请告知。我们将按阶段推进，每个阶段结束后进行成果确认。
         