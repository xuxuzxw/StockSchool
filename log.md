# StockSchool 项目开发日志（精简版）

## 项目概述

StockSchool是一个基于Python的量化投研系统，集成了数据获取、因子计算、策略评估、性能监控和告警等功能。本系统采用模块化设计，支持高度可配置化，适用于量化投资研究和策略开发。

## 核心功能模块

### 数据获取与同步
- **多数据源支持**: 集成Tushare和AkShare数据接口
- **全面数据覆盖**: 股票基本信息、日线行情、财务数据、市场情绪数据
- **增量同步**: 支持增量更新和断点续传
- **数据质量控制**: 自动数据清洗、异常值检测和缺失值处理

### 因子计算引擎
- **技术因子**: 20+种技术指标，包括动量、趋势、波动率、成交量因子
- **基本面因子**: 盈利能力、成长性、杠杆、流动性等财务指标
- **因子预处理**: 去极值、标准化、中性化等预处理功能
- **高性能计算**: 支持批量处理和并行计算

### AI模型训练与预测
- **多模型支持**: 线性回归、随机森林、XGBoost、LightGBM、神经网络
- **训练流水线**: 完整的模型训练、验证、保存流程
- **每日预测**: 自动化的每日股票预测脚本
- **模型解释**: 支持SHAP值计算和特征重要性分析
- **批量预测**: 支持历史时间段的批量预测和回测

### 全流程自动化调度
- **日度工作流**: 完整的从数据同步到AI预测的自动化流程
- **任务编排**: 基于Celery的分布式任务调度系统
- **质量保证**: 全面的数据质量检查和流程监控
- **容错机制**: 完善的错误处理和任务重试机制
- **性能监控**: 实时任务状态监控和性能基线建立

## 技术架构

### v1.1 核心功能升级
-  **数据库架构升级**: 新增`sentiment_data`、`factor_library`、`prediction_results`等核心表
-  **多数据源集成**: 完善Tushare数据同步，新增AkShare情绪数据同步
-  **配置参数化**: 所有数据同步参数支持配置文件管理
-  **基本面因子**: 新增9种基本面指标计算（ROE、ROA、成长性、杠杆等）
-  **因子预处理**: 实现去极值、标准化、中性化等预处理功能
-  **统一因子库**: 技术因子和基本面因子统一存储管理
-  **训练流水线**: 支持5种机器学习模型的完整训练流程
-  **每日预测**: 自动化预测脚本，支持模型加载和结果保存
-  **模型管理**: 模型版本控制和性能评估
-  **模块化设计**: 清晰的代码结构和职责分离
-  **错误处理**: 完善的异常捕获和重试机制
-  **日志系统**: 详细的操作日志和性能监控
-  **配置管理**: 统一的配置文件和参数管理

### v1.1.5 真实数据测试完成
-  **Docker测试环境**: 配置独立的PostgreSQL测试数据库
-  **测试数据管理**: 实现测试数据的自动生成和质量控制
-  **环境隔离**: 确保测试环境与生产环境完全隔离
-  **数据库连接测试**: 验证数据库连接和基础操作
-  **完整流水线测试**: 从数据获取到因子计算的完整流程验证
-  **因子计算精度验证**: 使用黄金数据验证RSI等技术指标的计算精度
-  **数据质量验证**: 确保价格数据的逻辑一致性
-  **计算一致性测试**: 验证MACD、布林带等复合指标的计算稳定性
-  **RSI计算优化**: 修复RSI计算逻辑，确保计算精度达到预期
-  **参数类型统一**: 统一技术指标函数的输入参数类型
-  **返回值标准化**: 标准化复合指标的返回值结构

### v1.1.6 全流程实测阶段
-  **AI模型模块**: 实现了AI模型的训练、预测和管理
-  **Celery任务扩展**: 扩展了AI相关的Celery任务，包括 `train_ai_model`、`run_prediction` 和 `batch_prediction`
-  **配置更新**: 新增 `full_test_config` 配置节，用于定义全流程测试的参数
-  **全流程调度系统**: 构建了主工作流调度脚本 (`run_daily_workflow.py`) 和全流程实测编排器 (`scripts/full_test_v1_1_6.py`)
-  **AI模型能力**: 支持多模型训练、批量预测和模型持久化
-  **任务调度架构**: 利用Celery的 `group`、`chain` 和 `chord` 功能进行任务编排
-  **测试配置**: 允许灵活设置测试日期范围和股票池
-  **工作流阶段**: 划分了数据同步、因子计算、AI模型训练、AI预测和数据质量检查等阶段
-  **质量保证体系**: 通过数据质量检查确保任务流执行一致性、输入数据完整性、中间产品覆盖率和最终成品时效性
-  **相关工具和脚本**: 创建了 `scripts/clear_database.py` 用于清空数据库
-  **技术特性**: 模块化设计、异步任务处理、可扩展性、容错机制和性能监控
-  **部署准备**: 支持Docker部署和Celery分布式任务队列

### v1.1.7 申万行业分类数据同步功能
-  **独立同步逻辑**: 解决了项目中缺少申万行业分类独立同步逻辑的问题，新增完整的行业数据同步功能
-  **多级行业支持**: 支持申万L1/L2/L3三级行业分类的独立同步和完整同步
-  **增量更新机制**: 使用UPSERT机制实现数据的增量更新，避免清空重插导致的数据不可用问题
-  **批量处理优化**: 采用批量API调用和数据库操作，显著提升同步效率
-  **参数化设计**: 通过`--level`参数支持不同行业层级的同步，增强功能灵活性
-  **错误处理完善**: 实现细粒度的异常处理和结构化日志记录，便于问题排查
-  **数据验证机制**: 添加数据验证逻辑，确保ts_code等关键字段的有效性
-  **频率控制**: 遵循Tushare API调用限制，通过配置参数控制调用频率
-  **命令行支持**: 扩展命令行接口，支持独立运行行业数据同步任务
-  **配置参数化**: 在配置文件中添加行业数据同步相关参数，便于调整和维护
-  **数据库优化**: 在数据库中创建唯一索引，优化UPSERT性能
-  **集成到完整同步**: 将申万行业分类数据同步集成到完整数据同步流程中

## 系统特性
- **特征工程**: 完整的特征商店系统，支持特征定义、存储和检索
- **策略评估**: 15+种策略评估指标，包括收益率、风险指标、绩效比率等
- **监控告警**: 实时性能监控和多渠道告警系统
- **Web API**: 基于FastAPI的RESTful API接口
- **高度可配置**: 所有关键参数支持配置文件动态加载

## 技术栈
- **后端框架**: FastAPI
- **数据库**: MySQL/SQLite
- **数据源**: Tushare Pro API, AkShare
- **机器学习**: scikit-learn, XGBoost, LightGBM, SHAP
- **数据处理**: pandas, numpy
- **技术指标**: talib, 自研指标库
- **配置管理**: PyYAML
- **任务调度**: Celery分布式任务队列
- **日志系统**: Python logging
- **重试机制**: 自研重试装饰器

## 部署与运维
- **Docker支持**: 提供完整的Docker部署方案
- **Celery分布式任务**: 支持分布式任务处理
- **监控告警**: 实时性能监控和异常告警
- **日志管理**: 完善的日志记录和轮转机制
- **运维工具**: 提供完整的运维和调试控制台

## 最新进展
- **全流程自动化**: 实现了从数据同步到AI预测的完整自动化流程
- **任务编排**: 基于Celery的任务编排系统，支持复杂的工作流定义
- **质量保证**: 完善的数据质量检查机制，确保数据的准确性和完整性
- **性能优化**: 通过并行计算和缓存机制提升系统性能
- **可扩展性**: 模块化设计，便于功能扩展和维护
- **行业数据支持**: 新增申万行业分类数据同步功能，完善数据维度